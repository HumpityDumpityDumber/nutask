#!/usr/bin/env nu

def getDataDir [] {
  let xdg_data_home = $env.XDG_DATA_HOME? | default ($env.HOME | path join ".local" "share")
  let nutask_dir = $xdg_data_home | path join "nutask"
  if not ($nutask_dir | path exists) {
    mkdir $nutask_dir
  }
  $nutask_dir
}

def getTasks [file:string] {
  if ($file | path exists) {
    open $file
  } else { [] }
}

def saveTask [name: string, length: duration, file: string, daily?: bool] {
  let t = (match $daily { null => { name: $name length: $length } _ => { name: $name length: $length daily: $daily} })
  let updated = (getTasks $file | append $t)
  $updated | save -f $file
}

let data_dir = getDataDir
let dailyTasks = { getTasks ($data_dir | path join "daily-tasks.nuon") }
let tasks = { getTasks ($data_dir | path join "tasks.nuon") }
let snoozedTasks = { getTasks ($data_dir | path join "snoozed-tasks.nuon") }


def main [] { help main }

# create a new task
def "main add" [name: string, length: duration, --daily] {
  if $daily {
    saveTask $name $length ($data_dir | path join "daily-tasks.nuon")
  } else {
    saveTask $name $length ($data_dir | path join "tasks.nuon") false
  }
}

# list tasks
def "main list" [
  --section (-s): string
  ] {
  match $section {
    "daily" => (do $dailyTasks)
  
    "snoozed" => (do $snoozedTasks)

    "tasks" => (do $tasks)

    null => (do $tasks)

    _ => $"(ansi red_bold)that section doesnt exist !(ansi reset)"
  }
}

# reset the task list; resets daily tasks, and adds snoozed tasks 
def "main reset" [] {
  do $tasks | where daily == false | collect | save -f ($data_dir | path join "tasks.nuon")
  for item in (do $dailyTasks) {
    saveTask $item.name $item.length ($data_dir | path join "tasks.nuon") true
  }
  for item in (do $snoozedTasks) {
    saveTask $item.name $item.length ($data_dir | path join "tasks.nuon") true
  }
  let snoozed_file = ($data_dir | path join "snoozed-tasks.nuon")
  if ($snoozed_file | path exists) { rm $snoozed_file }
}

# snooze a task; snoozed tasks are added back on next reset
def "main snooze" [name: string] {
  let newList = do $tasks | where name != $name
  let snoozedTask = do $tasks | where name == $name | reject daily
  $snoozedTask | save -f ($data_dir | path join "snoozed-tasks.nuon")
  $newList | save -f ($data_dir | path join "tasks.nuon")
}

def "main remove" [name: string] {
  let newList = do $tasks | where name != $name
  $newList | save -f ($data_dir | path join "tasks.nuon")
}